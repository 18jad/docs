---
title: 'Deploying to Vercel Edge Functions'
metaTitle: 'Deploying to Vercel Edge Functions'
metaDescription: 'Learn how to use Prisma with Vercel Edge Functions'
hidePage: true
---

<TopBlock>

Today you'll be building and deploying a Vercel Edge Function that uses Prisma to save page visits to your database so you can display active visitors on your website.

This guide will cover Prisma, Typescript, PostgreSQL, Prisma Data Proxy and Vercel Edge Functions from the ground up. Let's get started!

</TopBlock>

## Prerequisites

- Free [Vercel](https://vercel.com/) account.
- Free [GitHub](https://github.com/) account.
- Node.js & NPM installed.
- Git installed.

## 1. Set up your Application

Open your terminal and navigate to a location of your choice. Run the following commands to set up your application.

```terminal
mkdir prisma-vercel-edge
cd prisma-vercel-edge
npm init -y
npm install next react react-dom
npm install --save-dev prisma typescript vercel @types/react
```

## 5. Set up Prisma

Now you're ready to add Prisma to the project.

```terminal
npx prisma init
```

This will create a Prisma Schema in `prisma/schema.prisma` and an `.env` file.

Inside `prisma/schema.prisma`, add the following schema:

```prisma
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["dataProxy"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Visitor {
  ipHash   String   @id
  lastSeen DateTime @default(now())
}
```

This data model will be used to store visitor counts from your middleware.

## 6. Create Repository and Push to GitHub

To prepare for the steps ahead, let's [create a private repository](https://github.com/new) on GitHub.

![Create a private repository](./450-01-create-repo.png)

Next, initialize your repository, then push your changes up to GitHub.

```terminal
git init -b main
git remote add origin https://github.com/<username>/prisma-vercel-edge
git add .
git commit -m "initial commit"
git push -u origin main
```

You're ready to import your project into the Prisma Data Platform.

## 7. Importing your Project into the Prisma Data Platform

With Cloudflare Workers, you can't directly access your database because there is no TCP support. Fortunately, Prisma has your back with the Prisma Data Proxy.

To get started, sign up for a free [Prisma Data Platform account](https://cloud.prisma.io/).

![Signup for Prisma Data Platform](./450-02-signup-pdp.png)

Once you're in, click **New Project**, then **Import a Project**. Fill in the repository and project details, and then click **Create Project**.

![Import a Project](./450-03-import-project.png)

Next, you'll connect the Prisma Data Platform to MongoDB Atlas database and set up the Prisma Data Proxy:

![Connect your Database](./450-04-connect-db.png)

Click **Create Project** to test the connection and set up the Data Proxy.

<Admonition type="warning">

If you see, "The database needs to be empty to proceed", you can simply use a
different database name. Using the screenshot above, that would be renaming
`logs` to something else.

</Admonition>

If all goes well, you'll be greeted with a new connection string that starts with `prisma://`. Copy this connection string to your clipboard.

![Data Proxy Page](./450-05-data-proxy.png)

Then you can hop back into your code editor and paste the connection string into your `.env` file:

```env
DATABASE_URL="prisma://aws-us-east-1.prisma-data.com/?api_key=•••••••••••••••••"
```

You're all setup and ready to generate a Prisma Client!

<Admonition type="warning">
  Please be aware that the Data Proxy is in Early Access and should not be used
  in production.
</Admonition>

## 9. Generate a Prisma Client

Next you'll generate a Prisma Client that connects through the Data Proxy over HTTP.

```terminal
PRISMA_CLIENT_ENGINE_TYPE=dataproxy npx prisma generate
```

This client is optimized for edge environments like Cloudflare Workers.

<Admonition type="warning">

Please be aware that the proxy-enabled Prisma Client is in Early Access and
subject to change.

</Admonition>

## 10. Develop the Vercel Edge function

You're now ready to create a Vercel Edge function. Create a `pages/_middleware.ts` file with the following code:

```ts
import type { NextRequest, NextFetchEvent } from 'next/server'
import { PrismaClient } from '@prisma/client'
import { NextResponse } from 'next/server'
import { extname } from 'path'

const prisma = new PrismaClient()

export default async function middleware(req: NextRequest, ev: NextFetchEvent) {
  const { pathname } = req.nextUrl

  if (extname(pathname) !== '') {
    return NextResponse.next()
  }

  // Hash the incoming request IP
  const ipHash = await sha256(req.ip)

  // Instruct the middleware to continue processing, even
  ev.waitUntil(
    prisma.visitor.upsert({
      where: {
        ipHash: ipHash,
      },
      create: {
        ipHash: ipHash,
        lastSeen: new Date(),
      },
      update: {
        ipHash: ipHash,
        lastSeen: new Date(),
      },
    })
  )

  return new Response('hello from middleware')
}

async function sha256(str: string): Promise<string> {
  const buf = await crypto.subtle.digest(
    'SHA-256',
    new TextEncoder().encode(str)
  )
  return Array.prototype.map
    .call(new Uint8Array(buf), (x) => ('00' + x.toString(16)).slice(-2))
    .join('')
}
```

## 11. Create some Pages

Let's create two boilerplate-y Next.js pages to get a better sense of how middleware works.

First create a `pages/index.tsx` page with the following:

```tsx
export default function () {
  return <div>Index</div>
}
```

And a `pages/about.tsx` page with the following:

```tsx
export default function () {
  return <div>Index</div>
}
```

That'll be enough to demonstrate middleware.

## 12. Run next.js in development

Run `npx next` to see your worker in development:

```
ready - started server on 0.0.0.0:3000, url: http://localhost:3000
info  - Loaded env from /Users/m/dev/src/github.com/prisma/prisma-vercel-edge/.env
We detected TypeScript in your project and created a tsconfig.json file for you.

event - compiled successfully in 2.6s (159 modules)
```

Go ahead and open `http://localhost:3000`. If all goes well, you should see:

```
request method: GET!
```

Refresh the page a couple times to verify that it's working. Now if you click on the **Data Browser** tab on your Prisma Cloud project, you should see Info logs written to your database.

![Prisma Data Browser](./450-06-data-browser.png)

It's working locally!

## 11. Publishing to Vercel

You're now ready to deploy to Cloudflare Workers. Run the following command:

```terminal
npx wrangler publish
```

This will pack your application with webpack and upload to Cloudflare. With a bit of luck, you'll see the following:

```
✨  Built successfully, built project size is 94 KiB.
✨  Successfully published your script to
https://prisma-mongodb-cloudflare.mattm.workers.dev
```

Visit your deployment URL and you'll again see:

```
request method: GET!
```

You're all set! You've successfully deployed a Cloudflare Worker written in Typescript that uses Prisma to talk to your MongoDB database.

Give yourself a pat on the back, you deserve it!
